# 網路相簿

## 教科書章節

```
PHP7&MySQL跨裝置網站開發：
超威範例集(第二版)(附範例與資料庫光碟)
作者： 陳惠貞, 陳俊榮  
出版社：碁峰  

第22章　網路相簿
```

Title.png

index.php

logon.php

showAlbum.php

photoDetail.php

editPhoto.php

uploadPhoto.php

addAlbum.php

editAlbum.php

delAlbum.php
```
<?php
  require_once("dbtools.inc.php");
  
  $album_id = $_GET["album_id"];
  
  //取得登入者帳號
  session_start();
  $login_user = $_SESSION["login_user"];
  
  //建立資料連接
  $link = create_connection();
  
  //刪除儲存在硬碟的相片
  $sql = "SELECT filename FROM photo WHERE album_id = $album_id
          AND EXISTS(SELECT '*' FROM album WHERE id = $album_id AND owner = '$login_user')";
  $result = execute_sql($link, "album", $sql);
  
  while ($row = mysqli_fetch_assoc($result))
  {
    $file_name = $row["filename"];
    $photo_path = realpath("./Photo/$file_name");
    $thumbnail_path = realpath("./Thumbnail/$file_name");

    if (file_exists($photo_path))
      unlink($photo_path);

    if (file_exists($thumbnail_path))
      unlink($thumbnail_path);
  }
  
  //刪除儲存在資料庫的相片資訊
  $sql = "DELETE FROM photo WHERE album_id = $album_id
          AND EXISTS(SELECT '*' FROM album WHERE id = $album_id AND owner = '$login_user')";
  execute_sql($link, "album", $sql);

  //刪除儲存在資料庫的相簿資訊 	
  $sql = "DELETE FROM album WHERE id = $album_id AND owner = '$login_user'";
  execute_sql($link, "album", $sql);
  	
  //釋放記憶體並關閉資料連接
  mysqli_free_result($result);
  mysqli_close($link);

  header("location:index.php");
?>
```
delPhoto.php
```
<?php
  require_once("dbtools.inc.php");
  
  $album_id = $_GET["album_id"];
  $photo_id = $_GET["photo_id"];
  
  //取得登入者帳號
  session_start();
  $login_user = $_SESSION["login_user"];
  
  //建立資料連接
  $link = create_connection();
  
  //刪除儲存在硬碟的相片
  $sql = "SELECT filename FROM photo WHERE id = $photo_id
          AND EXISTS(SELECT '*' FROM album WHERE id = $album_id AND owner = '$login_user')";
  $result = execute_sql($link, "album", $sql);
  
  $file_name = mysqli_fetch_object($result)->filename;
  $photo_path = realpath("./Photo/$file_name");
  $thumbnail_path = realpath("./Thumbnail/$file_name");
  
  if (file_exists($photo_path))
    unlink($photo_path);
      
  if (file_exists($thumbnail_path))
    unlink($thumbnail_path);
  
  //刪除儲存在資料庫的相片資訊
  $sql = "DELETE FROM photo WHERE id = $photo_id
          AND EXISTS(SELECT '*' FROM album WHERE id = $album_id AND owner = '$login_user')";
  execute_sql($link, "album", $sql);
 	
  //釋放記憶體並關閉資料連接
  mysqli_free_result($result);
  mysqli_close($link);
  
  header("location:showAlbum.php?album_id=$album_id");
?>
```
dbtools.inc.php
```
<?php
  function create_connection()
  {
    $link = mysqli_connect("localhost", "root", "mypassword")
      or die("無法建立資料連接: " . mysqli_connect_error());
	  
    mysqli_query($link, "SET NAMES utf8");
			   	
    return $link;
  }
	
  function execute_sql($link, $database, $sql)
  {
    mysqli_select_db($link, $database)
      or die("開啟資料庫失敗: " . mysqli_error($link));
						 
    $result = mysqli_query($link, $sql);
		
    return $result;
  }
?>
```

logout.php
```
<?php
  session_start();
  session_unset();
  header("location:index.php");		
?>
```
album資料庫
